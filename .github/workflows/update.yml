---
name: Periodic Flake Update

on:
  schedule:
    - cron: "0 */5 * * *" # Every 5 hours (worst-case runtime ~5h)
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: flake-update
  cancel-in-progress: true

jobs:
  # Phase 1: Update flake.lock
  update-lock:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - run: nix flake update
      - uses: actions/upload-artifact@v4
        with:
          name: flake-lock
          path: flake.lock

  # Phase 2: Compute platform-specific hashes in parallel on native runners
  compute-hashes:
    needs: update-lock
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            platform: aarch64-darwin
          - runner: ubuntu-24.04
            platform: x86_64-linux
          - runner: ubuntu-24.04-arm
            platform: aarch64-linux
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: astral-sh/setup-uv@v7
      - uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - name: Compute hashes for ${{ matrix.platform }}
        # Run update.py directly with uv to avoid flake evaluation
        # (which fails when sources.json has stale hashes)
        run: uv run update.py --native-only
      - uses: actions/upload-artifact@v4
        with:
          name: sources-${{ matrix.platform }}
          path: sources.json

  # Phase 3: Merge platform-specific hashes
  merge-hashes:
    needs: compute-hashes
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - uses: actions/download-artifact@v4
        with:
          name: sources-aarch64-darwin
          path: sources-aarch64-darwin
      - uses: actions/download-artifact@v4
        with:
          name: sources-x86_64-linux
          path: sources-x86_64-linux
      - uses: actions/download-artifact@v4
        with:
          name: sources-aarch64-linux
          path: sources-aarch64-linux
      - name: Merge sources.json files
        run: |
          python3 .github/scripts/merge_sources.py \
            sources.json \
            sources-aarch64-darwin/sources.json \
            sources-x86_64-linux/sources.json \
            sources-aarch64-linux/sources.json \
            -o sources.json
      - uses: actions/upload-artifact@v4
        with:
          name: merged-sources
          path: |
            flake.lock
            sources.json

  # Phase 4: Build shared Darwin derivations to populate cache
  darwin-shared:
    needs: merge-hashes
    runs-on: macos-15
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h /

          # Keep only the latest Xcode, remove all others - saves ~60-80 GB
          latest_xcode=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          for xcode in /Applications/Xcode*.app; do
            [[ "$xcode" != "$latest_xcode" ]] && sudo rm -rf "$xcode"
          done

          # Remove all simulators - saves ~20-30 GB
          sudo rm -rf ~/Library/Developer/CoreSimulator
          xcrun simctl delete all 2>/dev/null || true

          # Remove Android SDK, .NET, and cached tools - saves ~30-40 GB
          sudo rm -rf ~/Library/Android/sdk /usr/local/share/dotnet ~/hostedtoolcache

          echo "=== After cleanup ==="
          df -h /

      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: cachix/cachix-action@v15
        with:
          name: gkze
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/download-artifact@v4
        with:
          name: merged-sources
          path: .
      - run: brew install --cask macfuse && brew install 1password-cli
      - name: Pre-fetch flake inputs
        run: nix flake archive --json > /dev/null
      - name: Build shared Darwin closure
        run: |
          python3 .github/scripts/build_shared_closure.py \
            .#darwinConfigurations.argus.system \
            .#darwinConfigurations.rocinante.system

  # Phase 5: Build Darwin configurations
  darwin:
    needs: [merge-hashes, darwin-shared]
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        host: [argus, rocinante]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h /

          # Keep only the latest Xcode, remove all others - saves ~60-80 GB
          latest_xcode=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          for xcode in /Applications/Xcode*.app; do
            [[ "$xcode" != "$latest_xcode" ]] && sudo rm -rf "$xcode"
          done

          # Remove all simulators - saves ~20-30 GB
          sudo rm -rf ~/Library/Developer/CoreSimulator
          xcrun simctl delete all 2>/dev/null || true

          # Remove Android SDK, .NET, and cached tools - saves ~30-40 GB
          sudo rm -rf ~/Library/Android/sdk /usr/local/share/dotnet ~/hostedtoolcache

          echo "=== After cleanup ==="
          df -h /

      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: cachix/cachix-action@v15
        with:
          name: gkze
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/download-artifact@v4
        with:
          name: merged-sources
          path: .
      - run: brew install --cask macfuse && brew install 1password-cli
      - name: Pre-fetch flake inputs
        run: nix flake archive --json > /dev/null
      - run: nix build .#darwinConfigurations.${{ matrix.host }}.system

  # Phase 6: Placeholder for future NixOS configuration builds
  linux:
    needs: merge-hashes
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: cachix/cachix-action@v15
        with:
          name: gkze
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/download-artifact@v4
        with:
          name: merged-sources
          path: .
      - run: nix run .#update -- --list

  # Phase 7: Create PR with updates
  create-pr:
    needs: [merge-hashes, darwin-shared, darwin, linux]
    if: ${{ needs.darwin.result == 'success' && needs.linux.result == 'success' }}
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: merged-sources
          path: .
      - name: Generate update diff
        id: diff
        run: |
          git show HEAD:flake.lock > /tmp/old-flake.lock
          flake_diff=$(python3 .github/scripts/flake_lock_diff.py /tmp/old-flake.lock flake.lock)

          # Generate sources.json diff if it changed
          sources_diff=""
          if ! git diff --quiet HEAD -- sources.json 2>/dev/null; then
            sources_diff=$(git diff HEAD -- sources.json | head -100)
          fi

          # Handle multiline output for GitHub Actions
          {
            echo 'body<<EOF'
            echo "$flake_diff"
            if [ -n "$sources_diff" ]; then
              echo ""
              echo "Sources.json changes:"
              echo "$sources_diff"
            fi
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v7
        with:
          sign-commits: true
          branch: update_flake_lock_action
          delete-branch: true
          title: "nix: Update flake.lock and sources"
          commit-message: "nix: Update flake.lock and sources"
          body: |
            Automated changes by the Periodic Flake Update workflow.

            ```
            ${{ steps.diff.outputs.body }}
            ```

            ### Running GitHub Actions on this PR

            GitHub Actions will not run workflows on pull requests which are opened by a GitHub Action.

            **To run GitHub Actions workflows on this PR, close and re-open this pull request.**
