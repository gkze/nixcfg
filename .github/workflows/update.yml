--- # !yamlfmt!:ignore
name: Periodic Flake Update

env:
  CACHIX_NAME: gkze

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: flake-update
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  # Phase 1: Update flake.lock
  update-lock:
    runs-on: ubuntu-24.04
    steps:
      - &checkout
        uses: actions/checkout@v4
      - &setup_nix
        uses: DeterminateSystems/determinate-nix-action@v3
      - &cachix
        uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_NAME }}
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - &cache_nix
        uses: actions/cache@v4
        with:
          path: ~/.cache/nix
          key: nix-cache-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: nix-cache-${{ runner.os }}-
      - run: nix run .#nixcfg -- ci nix-flake-update
      - uses: actions/upload-artifact@v4
        with:
          name: flake-lock
          path: flake.lock

  # Phase 2: Resolve upstream versions once (eliminates cross-platform race)
  resolve-versions:
    needs: update-lock
    runs-on: ubuntu-24.04
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - &download_flake_lock
        uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - &cache_nix_arch
        uses: actions/cache@v4
        with:
          path: ~/.cache/nix
          key: nix-cache-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('flake.lock') }}
          restore-keys: nix-cache-${{ runner.os }}-${{ runner.arch }}-
      - name: Resolve upstream versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: nix run .#nixcfg -- ci resolve-versions --output pinned-versions.json
      - uses: actions/upload-artifact@v4
        with:
          name: pinned-versions
          if-no-files-found: error
          path: pinned-versions.json

  # Phase 3: Compute platform-specific hashes in parallel on native runners
  compute-hashes:
    needs:
      - update-lock
      - resolve-versions
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            platform: aarch64-darwin
          - runner: ubuntu-24.04
            platform: x86_64-linux
          - runner: ubuntu-24.04-arm
            platform: aarch64-linux
    runs-on: ${{ matrix.runner }}
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - uses: actions/cache@v4
        with:
          path: ~/.cache/nix
          key: nix-cache-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('flake.lock') }}
          restore-keys: nix-cache-${{ runner.os }}-${{ runner.arch }}-
      - uses: actions/download-artifact@v4
        with:
          name: pinned-versions
          path: .
      - name: Free disk space
        if: runner.os == 'macOS'
        run: nix run .#nixcfg -- ci free-disk-space
      - name: Compute hashes for ${{ matrix.platform }}
        # Run update with pinned versions to ensure all platforms use the
        # same upstream version (resolved in the resolve-versions job).
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: nix run .#nixcfg -- update --native-only --pinned-versions pinned-versions.json
      - uses: actions/upload-artifact@v4
        with:
          name: sources-${{ matrix.platform }}
          if-no-files-found: error
          path: |
            packages/**/sources.json
            overlays/**/sources.json

  # Phase 4: Merge platform-specific hashes
  merge-hashes:
    needs: compute-hashes
    runs-on: ubuntu-24.04
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - *cache_nix
      - *download_flake_lock
      - uses: actions/download-artifact@v4
        with:
          name: sources-aarch64-darwin
          path: sources-aarch64-darwin
      - uses: actions/download-artifact@v4
        with:
          name: sources-x86_64-linux
          path: sources-x86_64-linux
      - uses: actions/download-artifact@v4
        with:
          name: sources-aarch64-linux
          path: sources-aarch64-linux
      - name: Merge per-package sources files
        run: |
          nix run .#nixcfg -- ci merge-sources \
            sources-aarch64-darwin \
            sources-x86_64-linux \
            sources-aarch64-linux
      - uses: actions/upload-artifact@v4
        with:
          name: merged-sources
          path: |
            flake.lock
            packages/**/sources.json
            overlays/**/sources.json

  # Phase 5: Build shared Darwin derivations to populate cache
  darwin-shared:
    needs: merge-hashes
    runs-on: macos-15
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - &download_merged_sources
        uses: actions/download-artifact@v4
        with:
          name: merged-sources
          path: .
      - *cache_nix_arch
      - name: Free disk space
        run: nix run .#nixcfg -- ci free-disk-space
      - run: nix run .#nixcfg -- ci install-darwin-tools
      - name: Pre-fetch flake inputs
        run: nix run .#nixcfg -- ci prefetch-flake-inputs
      - name: Build shared Darwin closure
        run: |
          nix run .#nixcfg -- ci build-shared-closure \
            .#darwinConfigurations.argus.system \
            .#darwinConfigurations.rocinante.system

  # Phase 6: Build Darwin configurations
  darwin:
    needs:
      - merge-hashes
      - darwin-shared
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        host:
          - argus
          - rocinante
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - *download_merged_sources
      - *cache_nix_arch
      - name: Free disk space
        run: nix run .#nixcfg -- ci free-disk-space
      - run: nix run .#nixcfg -- ci install-darwin-tools
      - name: Pre-fetch flake inputs
        run: nix run .#nixcfg -- ci prefetch-flake-inputs
      - run: nix run .#nixcfg -- ci build-darwin-config "${{ matrix.host }}"

  # Phase 7: Placeholder for future NixOS configuration builds
  linux:
    needs: merge-hashes
    runs-on: ubuntu-24.04
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - *download_merged_sources
      - *cache_nix_arch
      - name: Smoke-check update app evaluation
        run: nix run .#nixcfg -- ci smoke-check-update-app
      - run: nix run .#nixcfg -- ci list-update-targets

  # Phase 8: Create PR with updates
  create-pr:
    needs:
      - merge-hashes
      - darwin-shared
      - darwin
      - linux
    if: >-
      needs.merge-hashes.result == 'success' &&
      needs.darwin-shared.result == 'success' &&
      needs.darwin.result == 'success' &&
      needs.linux.result == 'success'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - *checkout
      - *setup_nix
      - *cachix
      - *cache_nix
      - *download_merged_sources
      - name: Generate PR body
        run: |
          nix run .#nixcfg -- ci generate-pr-body \
            --output /tmp/pr-body.md \
            --workflow-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --server-url "${{ github.server_url }}" \
            --repository "${{ github.repository }}" \
            --base-ref "${{ github.base_ref || github.event.repository.default_branch }}"

      - uses: peter-evans/create-pull-request@v7
        id: cpr
        with:
          sign-commits: true
          branch: update_flake_lock_action
          delete-branch: true
          title: "nix: Update flake.lock and sources"
          commit-message: "nix: Update flake.lock and sources"
          body-path: /tmp/pr-body.md
