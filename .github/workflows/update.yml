---
name: Nightly Flake Update

on:
  schedule:
    - cron: "0 11 * * *" # 3:00 AM PST / 4:00 AM PDT
  workflow_dispatch:

jobs:
  update-lock:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - run: nix flake update
      - uses: actions/upload-artifact@v4
        with:
          name: flake-lock
          path: flake.lock

  darwin:
    needs: update-lock
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        host: [argus, rocinante]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h /

          # Keep only the latest Xcode, remove all others - saves ~60-80 GB
          latest_xcode=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          for xcode in /Applications/Xcode*.app; do
            [[ "$xcode" != "$latest_xcode" ]] && sudo rm -rf "$xcode"
          done

          # Remove all simulators - saves ~20-30 GB
          sudo rm -rf ~/Library/Developer/CoreSimulator
          xcrun simctl delete all 2>/dev/null || true

          # Remove Android SDK, .NET, and cached tools - saves ~30-40 GB
          sudo rm -rf ~/Library/Android/sdk /usr/local/share/dotnet ~/hostedtoolcache

          echo "=== After cleanup ==="
          df -h /

      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: cachix/cachix-action@v15
        with:
          name: gkze
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - run: brew install --cask macfuse && brew install 1password-cli
      - run: nix build .#darwinConfigurations.${{ matrix.host }}.system

  linux:
    needs: update-lock
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: cachix/cachix-action@v15
        with:
          name: gkze
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - run: nix run .#update -- --list

  create-pr:
    needs: [update-lock, darwin, linux]
    if: ${{ needs.darwin.result == 'success' && needs.linux.result == 'success' }}
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: actions/download-artifact@v4
        with:
          name: flake-lock
          path: .
      - name: Generate flake lock diff
        id: diff
        run: |
          git show HEAD:flake.lock > /tmp/old-flake.lock
          diff_body=$(python3 .github/scripts/flake_lock_diff.py /tmp/old-flake.lock flake.lock)

          # Handle multiline output for GitHub Actions
          {
            echo 'body<<EOF'
            echo "$diff_body"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - uses: peter-evans/create-pull-request@v7
        with:
          sign-commits: true
          branch: update_flake_lock_action
          delete-branch: true
          title: "flake.lock: Update"
          commit-message: "flake.lock: Update"
          body: |
            Automated changes by the Nightly Flake Update workflow.

            ```
            ${{ steps.diff.outputs.body }}
            ```

            ### Running GitHub Actions on this PR

            GitHub Actions will not run workflows on pull requests which are opened by a GitHub Action.

            **To run GitHub Actions workflows on this PR, close and re-open this pull request.**
